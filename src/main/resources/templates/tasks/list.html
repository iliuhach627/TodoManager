<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/tasks.css" rel="stylesheet">
    <link href="/css/keywords.css" rel="stylesheet">
    <link href="/css/navbar.css" rel="stylesheet">
    <link href="/css/search-collapse.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/tags.css" rel="stylesheet">
    <link href="/css/task-cards.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="/tasks">
            <i class="fas fa-tasks me-2"></i>Task Manager
        </a>
        <div>
            <a th:href="@{/keywords}" class="btn btn-outline-primary me-2">
                <i class="fas fa-key me-1"></i>Ключевые слова
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Основной контент -->
        <div class="col-lg-9 mb-4">
            <!-- Компактная строка поиска и фильтров -->
            <div class="search-filter-row mb-4">
                <div class="card">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <!-- Поиск -->
                            <div class="col-md-4">
                                <form th:action="@{/tasks/search}" method="get" class="d-flex">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" name="keyword"
                                               th:value="${searchKeyword ?: ''}"
                                               placeholder="Поиск задач..." aria-label="Поиск задач">
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Фильтр по тегам -->
                            <div class="col-md-3">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-tags me-1"></i>Теги
                                    </button>
                                    <ul class="dropdown-menu p-2">
                                        <li th:each="tag : ${allTags}">
                                            <a class="dropdown-item" th:href="@{'/tasks/filter/tag/' + ${tag.id}}">
                                                    <span th:text="${tag.name}"
                                                          th:style="'color: ' + ${tag.color}"></span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Фильтр по дате -->
                            <div class="col-md-3">
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" type="button"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-calendar me-1"></i>Дата
                                    </button>
                                    <ul class="dropdown-menu p-3" style="min-width: 300px;">
                                        <li><a class="dropdown-item" href="#" onclick="dateFilter.setQuickRange('today')">Сегодня</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="dateFilter.setQuickRange('week')">Неделя</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="dateFilter.setQuickRange('month')">Месяц</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form th:action="@{/tasks/filter/date/custom}" method="get" class="date-range-form">
                                                <div class="mb-2">
                                                    <label class="form-label small text-muted mb-1">Начальная дата *</label>
                                                    <input id="startDate" type="date" name="startDate" class="form-control form-control-sm"
                                                           th:value="${startDate}">
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label small text-muted mb-1">Конечная дата *</label>
                                                    <input id="endDate" type="date" name="endDate" class="form-control form-control-sm"
                                                           th:value="${endDate}">
                                                </div>
                                                <button id="findTasksByDate" type="submit" class="btn btn-primary btn-sm w-100" disabled>
                                                    <i class="fas fa-filter me-1"></i>Применить
                                                </button>
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100"
                                                            onclick="dateFilter.clearFilters()">
                                                        <i class="fas fa-eraser me-1"></i>Очистить
                                                    </button>
                                                </div>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <!-- Кнопка сброса -->
                            <div class="col-md-2">
                                <form th:action="@{/tasks}" method="get">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="fas fa-times"></i> Сброс
                                    </button>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Результаты поиска -->
            <div th:if="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds)) or dateFilter != null}"
                 class="alert alert-info mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">Результаты поиска: </span>
                        <span th:text="${searchResultsCount}"></span> задач

                        <span th:if="${searchKeyword != null}">по запросу "<span class="fw-bold"
                                                                                 th:text="${searchKeyword}"></span>"
                            </span>

                        <span th:if="${selectedTagIds != null and not #lists.isEmpty(selectedTagIds)}">с тегами:<span
                                th:each="tagId : ${selectedTagIds}" class="badge me-1">
                                    <span th:each="tag : ${allTags}"
                                          th:if="${tag.id == tagId}"
                                          th:text="${tag.name}"
                                          th:style="'background-color: ' + ${tag.color} + '; color: white'"
                                          class="badge me-1"></span>
                                </span>
                            </span>

                        <span th:if="${dateFilter != null}">за период: <span class="fw-bold"
                                                                             th:text="${dateFilter}"></span>
                            </span>
                    </div>
                </div>
            </div>

            <!-- Список активных задач -->
            <h5 class="mb-3 fw-bold text-dark">
                <i class="fas fa-list-check me-2"></i>
                <span th:if="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds)) or dateFilter != null}">Результаты поиска</span>
                <span th:if="${not (searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds)) or dateFilter != null)}">Текущие задачи</span>
                <span class="badge bg-primary ms-2" th:text="${activeTasks.size()}"></span>
                <button class="btn btn-sm btn-outline-secondary toggle-section-btn"
                        data-bs-target=".active-tasks-container">
                    <i class="fa-solid fa-chevron-up collapse-icon"></i>
                </button>
            </h5>

            <div class="active-tasks-container">
                <div th:if="${#lists.isEmpty(activeTasks)}" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <span th:if="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds)) or dateFilter != null}">
                        По вашему запросу ничего не найдено
                    </span>
                    <span th:if="${not (searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds)) or dateFilter != null)}">
                        Нет активных задач. Создайте первую задачу!
                    </span>
                </div>

                <!-- Карточки задач -->
                <div th:each="task : ${activeTasks}" class="task-card"
                     th:classappend="'priority-' + ${task.priority?.toString().toLowerCase()}">

                    <div class="card">
                        <!-- Заголовок задачи -->
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">
                                        <a th:href="@{/tasks/{id}(id=${task.customId})}"
                                           class="text-decoration-none text-dark fw-bold"
                                           th:text="${task.customId + ': ' + task.title}"></a>

                                        <!-- Статус -->
                                        <span th:if="${task.status == T(org.shetsko.model.enums.TaskStatus).COMPLETED}"
                                              class="badge bg-success ms-2">
                                            <i class="fas fa-check"></i>
                                        </span>
                                    </h6>
                                </div>

                                <div class="d-flex align-items-center task-actions">
                                    <!-- Теги -->
                                    <span th:each="tag : ${task.tags}" class="badge me-1"
                                          th:style="'background-color: ' + ${tag.color} + '; color: white'"
                                          th:text="${tag.name}"></span>

                                    <!-- Кнопка комментариев -->
                                    <button class="btn btn-sm btn-outline-secondary ms-2 comments-btn"
                                            th:attr="data-task-id=${task.customId}"
                                            th:classappend="${#lists.size(task.comments) > 0} ? 'has-comments' : ''">
                                        <i class="fas fa-comment"></i>
                                        <span th:if="${#lists.size(task.comments) > 0}"
                                              class="ms-1" th:text="${#lists.size(task.comments)}"></span>
                                    </button>

                                    <form th:action="@{'/tasks/delete/' + ${task.customId}}" method="post" class="ms-2">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>

                                    <!-- Кнопка завершения -->
                                    <form th:if="${task.status != T(org.shetsko.model.enums.TaskStatus).COMPLETED}"
                                          th:action="@{/tasks/{id}/complete(id=${task.customId})}"
                                          method="post" class="ms-2">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Описание задачи -->
                        <div class="card-body collapse description-section">
                            <!-- Описание -->
                            <div class="mb-2">
                                <span class="card-text">
                                    <th:block th:each="part : ${keywordService.highlightKeywords(task.description)}">
                                        <th:block th:utext="${part}"></th:block>
                                    </th:block>
                                </span>
                            </div>

                            <!-- Ключевые слова -->
                            <div th:if="${not #sets.isEmpty(keywordService.findKeywordsInTask(task))}" class="mb-3">
                                <span class="text-muted me-2">Ключевые слова:</span>
                                <div class="d-flex flex-wrap gap-1">
                                    <th:block th:each="keyword : ${keywordService.findKeywordsInTask(task)}">
                                    <span class="keyword-badge position-relative"
                                          th:attr="data-keyword=${keyword}">
                                        <span th:text="${keyword}"></span>
                                            <span class="keyword-source-tooltip">
                                            <i class="fas fa-info-circle ms-1"></i>
                                                    <span class="keyword-source-content">
                                                    <strong th:text="${keyword}"></strong><br>
                                                    <span th:text="'Найдено в этой задаче'"></span>
                                                    </span>
                                            </span>
                                    </span>
                                    </th:block>
                                </div>
                            </div>

                            <!-- Ссылки на связанные задачи -->
                            <div th:if="${not #sets.isEmpty(task.referencedTasks)}" class="mt-2">
                                <small class="text-muted">Связанные задачи:</small>
                                <div class="d-flex flex-wrap gap-1">
                                        <span th:each="refTask : ${task.referencedTasks}"
                                              class="badge bg-light text-dark border">
                                            <a th:href="@{/tasks/{id}(id=${refTask.customId})}"
                                               class="text-decoration-none text-dark"
                                               th:text="${refTask.customId}"></a>
                                        </span>
                                </div>
                            </div>

                            <!-- Комментарии -->
                            <div class="comments-container collapse mt-3">
                                <small class="text-muted d-block mb-2">Комментарии:</small>
                                <div th:each="comment : ${task.comments}" class="card mb-2">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <p class="card-text mb-0 small" th:text="${comment.content}"></p>
                                            <small class="text-muted">
                                                <i class="far fa-clock me-1"></i>
                                                <span th:text="${#temporals.format(comment.createdAt, 'dd.MM.yy HH:mm')}"></span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Футер карточки -->
                            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                <small class="text-muted">
                                    <i class="far fa-calendar me-1"></i>
                                    <span th:text="${#temporals.format(task.createdAt, 'dd.MM.yy HH:mm')}"></span>
                                </small>

                                <small th:classappend="${task.priority == T(org.shetsko.model.enums.Priority).HIGH} ? 'text-danger' :
                                                      (${task.priority == T(org.shetsko.model.enums.Priority).MEDIUM} ? 'text-warning' : 'text-success')">
                                    <i class="fas fa-flag me-1"></i>
                                    <span th:text="${task.priority.getTranslate()}"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Выполненные задачи -->
            <div th:if="${not #lists.isEmpty(completedTasks)}" class="mt-4">
                <h5 class="mb-3 fw-bold text-dark">
                    <i class="fas fa-check-circle me-2"></i>Выполненные задачи
                    <span class="badge bg-success ms-2" th:text="${completedTasks.size()}"></span>
                    <button class="btn btn-sm btn-outline-secondary toggle-section-btn"
                            data-bs-target=".completed-tasks-container">
                        <i class="fa-solid fa-chevron-up collapse-icon"></i>
                    </button>
                </h5>
                <div class="completed-tasks-container">
                    <div th:each="task : ${completedTasks}" class="task-card completed"
                         th:classappend="'priority-' + ${task.priority?.toString().toLowerCase()}">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">
                                            <a th:href="@{/tasks/{id}(id=${task.customId})}"
                                               class="text-decoration-none text-muted fw-bold text-decoration-line-through"
                                               th:text="${task.customId + ': ' + task.title}"></a>
                                            <span class="badge bg-success ms-2">Выполнено</span>
                                        </h6>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span th:each="tag : ${task.tags}" class="badge me-1"
                                              th:style="'background-color: ' + ${tag.color} + '; color: white'"
                                              th:text="${tag.name}"></span>
                                        <button class="btn btn-sm btn-outline-secondary ms-2 comments-btn"
                                                th:attr="data-task-id=${task.customId}">
                                            <i class="fas fa-comment"></i>
                                            <span th:if="${#lists.size(task.comments) > 0}"
                                                  class="ms-1" th:text="${#lists.size(task.comments)}"></span>
                                        </button>
                                    </div>
                                    <form th:action="@{'/tasks/delete/' + ${task.customId}}" method="post" class="ms-2">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <!-- Описание задачи -->
                            <div class="card-body collapse description-section">
                                <!-- Описание -->
                                <div class="mb-2">
                                <span class="card-text">
                                    <th:block th:each="part : ${keywordService.highlightKeywords(task.description)}">
                                        <th:block th:utext="${part}"></th:block>
                                    </th:block>
                                </span>
                                </div>

                                <!-- Ключевые слова -->
                                <div th:if="${not #sets.isEmpty(keywordService.findKeywordsInTask(task))}" class="mb-3">
                                    <span class="fw-bold text-muted me-2">Ключевые слова:</span>
                                    <div class="d-flex flex-wrap gap-1">
                                        <th:block th:each="keyword : ${keywordService.findKeywordsInTask(task)}">
                                    <span class="keyword-badge position-relative"
                                          th:attr="data-keyword=${keyword}">
                                        <span th:text="${keyword}"></span>
                                            <span class="keyword-source-tooltip">
                                            <i class="fas fa-info-circle ms-1"></i>
                                                    <span class="keyword-source-content">
                                                    <strong th:text="${keyword}"></strong><br>
                                                    <span th:text="'Найдено в этой задаче'"></span>
                                                    </span>
                                            </span>
                                    </span>
                                        </th:block>
                                    </div>
                                </div>

                                <!-- Комментарии -->
                                <div class="comments-container collapse mt-3">
                                    <small class="text-muted d-block mb-2">Комментарии:</small>
                                    <div th:each="comment : ${task.comments}" class="card mb-2">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <p class="card-text mb-0 small" th:text="${comment.content}"></p>
                                                <small class="text-muted">
                                                    <i class="far fa-clock me-1"></i>
                                                    <span th:text="${#temporals.format(comment.createdAt, 'dd.MM.yy HH:mm')}"></span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Футер карточки -->
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                    <small class="text-muted">
                                        <i class="far fa-calendar me-1"></i>
                                        <span th:text="${#temporals.format(task.createdAt, 'dd.MM.yy HH:mm')}"></span>
                                    </small>

                                    <small th:classappend="${task.priority == T(org.shetsko.model.enums.Priority).HIGH} ? 'text-danger' :
                                                      (${task.priority == T(org.shetsko.model.enums.Priority).MEDIUM} ? 'text-warning' : 'text-success')">
                                        <i class="fas fa-flag me-1"></i>
                                        <span th:text="${task.priority.getTranslate()}"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Сайдбар справа -->
        <div class="col-lg-3">
            <div class="sidebar-sticky">
                <!-- Создание задачи -->
                <div class="card mb-4">
                    <div class="card-header">
                        <button class="sidebar-btn w-100" data-bs-toggle="collapse" data-bs-target="#createTaskForm">
                            <i class="fas fa-plus-circle me-2"></i>Новая задача
                        </button>
                    </div>
                    <div class="collapse" id="createTaskForm">
                        <div class="card-body">
                            <form th:action="@{/tasks/create}" method="post" th:object="${newTask}">
                                <div class="mb-3">
                                    <label class="form-label">Заголовок *</label>
                                    <input type="text" class="form-control" th:field="*{title}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Описание</label>
                                    <textarea class="form-control" th:field="*{description}" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Приоритет</label>
                                    <select class="form-select" th:field="*{priority}">
                                        <option th:each="priority : ${T(org.shetsko.model.enums.Priority).values()}"
                                                th:value="${priority}"
                                                th:text="${priority.getTranslate()}"></option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Теги</label>
                                    <select class="form-select" multiple name="tagIds">
                                        <option th:each="tag : ${allTags}"
                                                th:value="${tag.id}"
                                                th:text="${tag.name}"
                                                th:style="'color: ' + ${tag.color}"></option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-save me-1"></i>Создать
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Управление тегами -->
                <div class="card mb-4">
                    <div class="card-header">
                        <button class="sidebar-btn w-100" data-bs-toggle="collapse" data-bs-target="#tagManagement">
                            <i class="fas fa-tags me-2"></i>Управление тегами
                        </button>
                    </div>
                    <div class="collapse" id="tagManagement">
                        <div class="card-body">
                            <form th:action="@{/tasks/tags/create}" method="post" th:object="${newTag}">
                                <div class="mb-3">
                                    <label class="form-label">Название тега *</label>
                                    <input type="text" class="form-control" th:field="*{name}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Цвет</label>
                                    <input type="color" class="form-control form-control-color"
                                           th:field="*{color}" value="#563d7c">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-plus me-1"></i>Создать тег
                                </button>
                            </form>

                            <div class="tag-list mt-3">
                                <h6 class="fw-bold mb-3">Мои теги:</h6>
                                <div th:each="tag : ${allTags}"
                                     class="tag-item d-flex justify-content-between align-items-center mb-2">
                                        <span class="badge" th:style="'background-color: ' + ${tag.color}"
                                              th:text="${tag.name}"></span>
                                    <form th:action="@{'/tasks/tags/delete/' + ${tag.id}}" method="post">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/date.js"></script>
<script src="/js/comments.js"></script>
<script src="/js/highlight-keywords.js"></script>
<script src="/js/search-task-collapse.js"></script>
<script src="/js/task-drop-down.js"></script>
<script src="/js/task-collapse.js"></script>
<script src="/js/task-references.js"></script>
</body>
</html>