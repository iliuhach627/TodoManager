<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/tasks.css" rel="stylesheet">
</head>
<body>
<!-- Навигационная панель -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="/tasks">
            <i class="fas fa-tasks me-2"></i>Task Manager
        </a>
        <div>
            <a href="/keywords" class="btn btn-outline-primary">
                <i class="fa-regular fa-pen-to-square me-1"></i>Ключевые слова
            </a>
            <a href="/tasks" class="btn btn-outline-primary">
                <i class="fas fa-home me-1"></i>На главную
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Основной контент -->
        <div class="col-lg-9 mb-4">
            <!-- Форма поиска -->
            <!-- Кнопка показа/скрытия поиска -->
            <div class="mb-3">
                <button class="btn btn-primary collapsible-search-btn" type="button" data-bs-toggle="collapse"
                        data-bs-target="#searchCard" aria-expanded="false"
                        th:attr="aria-expanded=${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds))} ? 'true' : 'false'">
                    <i class="fas fa-search me-2"></i>
                    <span class="search-btn-text">
            <th:block th:if="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds))}">
                Скрыть поиск и фильтры
            </th:block>
            <th:block th:unless="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds))}">
                Показать поиск и фильтры
            </th:block>
        </span>
                    <i class="fas ms-2 search-arrow"
                       th:classappend="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds))} ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </button>
            </div>

            <!-- Карточка поиска -->
            <div class="card mb-4 collapse" id="searchCard"
                 th:classappend="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds))} ? 'show' : ''">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Поиск и фильтрация задач</h5>
                    <button type="button" class="btn-close" data-bs-target="#searchCard" data-bs-toggle="collapse"
                            aria-label="Закрыть"></button>
                </div>
                <div class="card-body">
                    <form th:action="@{/tasks/search}" method="get" class="row g-3">
                        <!-- Поиск по ключевым словам -->
                        <div class="col-md-6">
                            <label class="form-label">Поиск по ключевым словам</label>
                            <input type="text" class="form-control" name="keyword"
                                   th:value="${searchKeyword ?: ''}"
                                   placeholder="Введите слово для поиска...">
                        </div>

                        <!-- Фильтр по тегам -->
                        <div class="col-md-6">
                            <label class="form-label">Фильтр по тегам</label>
                            <select class="form-select" multiple name="tagIds" size="4">
                                <option th:each="tag : ${allTags}"
                                        th:value="${tag.id}"
                                        th:text="${tag.name}"
                                        th:selected="${selectedTagIds != null and selectedTagIds.contains(tag.id)}"
                                        th:style="'color: ' + ${tag.color}"></option>
                            </select>
                            <small class="text-muted">Для выбора нескольких тегов используйте Ctrl+Click</small>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Найти
                            </button>
                            <a th:href="@{/tasks}" class="btn btn-outline-secondary ms-2">
                                <i class="fas fa-times me-1"></i>Сбросить
                            </a>
                        </div>
                    </form>

                    <!-- Быстрые фильтры по тегам -->
                    <div th:if="${not #lists.isEmpty(allTags)}" class="mt-4">
                        <label class="form-label">Быстрые фильтры:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <a th:each="tag : ${allTags}"
                               th:href="@{'/tasks/filter/tag/' + ${tag.id}}"
                               class="btn btn-sm btn-outline-primary"
                               th:style="'border-color: ' + ${tag.color} + '; color: ' + ${tag.color}">
                                <i class="fas fa-tag me-1"></i>
                                <span th:text="${tag.name}"></span>
                            </a>
                        </div>
                    </div>

                    <!-- Результаты поиска -->
                    <div th:if="${searchKeyword != null or (selectedTagIds != null and not #lists.isEmpty(selectedTagIds))}"
                         class="mt-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">Результаты поиска: </span>
                                <span class="text-muted">найдено </span>
                                <span class="badge bg-primary" th:text="${searchResultsCount}"></span>
                                <span class="text-muted"> задач</span>

                                <span th:if="${searchKeyword != null}">
                        <span class="text-muted">по запросу "</span>
                        <span class="fw-bold text-primary" th:text="${searchKeyword}"></span>
                        <span class="text-muted">"</span>
                    </span>

                                <span th:if="${selectedTagIds != null and not #lists.isEmpty(selectedTagIds)}">
                        <span class="text-muted">с тегами: </span>
                        <span th:each="tagId : ${selectedTagIds}" class="badge me-1">
                            <span th:each="tag : ${allTags}"
                                  th:if="${tag.id == tagId}"
                                  th:text="${tag.name}"
                                  th:style="'background-color: ' + ${tag.color} + '; color: white'"
                                  class="badge me-1"></span>
                        </span>
                    </span>

                                <span th:if="${activeResultsCount} > 0" class="ms-2">
                        <span class="badge bg-info" th:text="${activeResultsCount} + ' активных'"></span>
                    </span>

                                <span th:if="${completedResultsCount} > 0" class="ms-1">
                        <span class="badge bg-success" th:text="${completedResultsCount} + ' выполненных'"></span>
                    </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Список активных задач -->
            <h4 class="mb-3 fw-bold">Текущие задачи</h4>

            <div th:if="${#lists.isEmpty(activeTasks)}" class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>Нет активных задач
            </div>

            <div th:each="task : ${activeTasks}" class="task-card mb-3"
                 th:classappend="${task.priority == T(org.shetsko.model.enums.Priority).HIGH} ? 'high-priority' :
                                   (${task.priority == T(org.shetsko.model.enums.Priority).MEDIUM} ? 'medium-priority' : 'low-priority')">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <a th:href="@{/tasks/{id}(id=${task.customId})}"
                               th:text="${task.customId + ': ' + task.title}"
                               class="text-decoration-none"></a>
                        </h5>
                        <div>
                                <span th:each="tag : ${task.tags}"
                                      class="badge me-1"
                                      th:style="'background-color: ' + ${tag.color} + '; color: white'"
                                      th:text="${tag.name}"></span>
                            <form th:action="@{/tasks/{id}/complete(id=${task.customId})}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="fas fa-check me-1"></i>Завершить
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Описание с подсветкой ключевых слов -->
                        <div class="mb-3">
                            <span class="fw-bold text-muted me-2">Описание:</span>
                            <span class="card-text" th:classappend="${task.status == T(org.shetsko.model.enums.TaskStatus).COMPLETED} ? 'text-muted' : ''">
            <th:block th:each="part : ${keywordService.highlightKeywords(task.description)}">
                <th:block th:utext="${part}"></th:block>
            </th:block>
        </span>
                        </div>

                        <!-- Все ключевые слова (заголовок + описание + комментарии) -->
                        <div th:if="${not #sets.isEmpty(keywordService.findKeywordsInTask(task))}" class="mb-3">
                            <span class="fw-bold text-muted me-2">Ключевые слова:</span>
                            <div class="d-flex flex-wrap gap-1">
                                <th:block th:each="keyword : ${keywordService.findKeywordsInTask(task)}">
                <span class="keyword-badge position-relative"
                      th:attr="data-keyword=${keyword}">
                                    <span th:text="${keyword}"></span>
                                    <span class="keyword-source-tooltip">
                        <i class="fas fa-info-circle ms-1"></i>
                        <span class="keyword-source-content">
                            <strong th:text="${keyword}"></strong><br>
                            <span th:text="'Найдено в этой задаче'"></span>
                        </span>
                    </span>
                                    </span>
                                </th:block>
                            </div>
                        </div>

                        <!-- Комментарии -->
                        <div class="comments-section">
                            <button class="btn btn-sm btn-outline-secondary toggle-comments"
                                    th:classappend="${task.status == T(org.shetsko.model.enums.TaskStatus).COMPLETED} ? 'btn-outline-success' : 'btn-outline-secondary'"
                                    th:attr="data-task-id=${task.customId}">
                                <i class="fas fa-comments me-1"></i>
                                Комментарии (<span th:text="${#lists.size(task.comments)}"></span>)
                            </button>
                            <div class="comments-container mt-2 collapse">
                                <div th:each="comment : ${task.comments}" class="card mt-2">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <p class="card-text mb-0" th:text="${comment.content}"></p>
                                            <small class="text-muted">
                                                <i class="far fa-clock me-1"></i>
                                                <span th:text="${#temporals.format(comment.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
                                            </small>
                                        </div>

                                        <!-- Ключевые слова в комментариях -->
                                        <div th:if="${not #sets.isEmpty(keywordService.findKeywords(comment.content))}"
                                             class="mt-2">
                                            <small class="text-muted">Ключевые слова в комментарии:</small>
                                            <div class="d-flex flex-wrap gap-1 mt-1">
                            <span th:each="keyword : ${keywordService.findKeywords(comment.content)}"
                                  class="keyword-badge-sm"
                                  th:text="${keyword}"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted bg-transparent">
                        <small>
                            <i class="far fa-calendar-alt me-1"></i>
                            Создано: <span th:text="${#temporals.format(task.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Сайдбар справа -->
        <div class="col-lg-3">
            <div class="sidebar-sticky">
                <!-- Создание задачи -->
                <div class="sidebar-card mb-4">
                    <button class="sidebar-btn" data-bs-toggle="collapse" data-bs-target="#createTaskForm">
                        <i class="fas fa-plus-circle me-2"></i>Новая задача
                    </button>
                    <div class="collapse mt-3" id="createTaskForm">
                        <form th:action="@{/tasks/create}" method="post" th:object="${newTask}">
                            <div class="mb-3">
                                <label class="form-label">Заголовок</label>
                                <input type="text" class="form-control" th:field="*{title}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Описание</label>
                                <textarea class="form-control" th:field="*{description}" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Приоритет</label>
                                <select class="form-select" th:field="*{priority}">
                                    <option th:each="priority : ${T(org.shetsko.model.enums.Priority).values()}"
                                            th:value="${priority}"
                                            th:text="${priority.getTranslate()}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Теги</label>
                                <select class="form-select" multiple name="tagIds">
                                    <option th:each="tag : ${allTags}"
                                            th:value="${tag.id}"
                                            th:text="${tag.name}"
                                            th:style="'color: ' + ${tag.color}"></option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-save me-1"></i>Создать задачу
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Управление тегами -->
                <div class="sidebar-card mb-4">
                    <button class="sidebar-btn" data-bs-toggle="collapse" data-bs-target="#tagManagement">
                        <i class="fas fa-tags me-2"></i>Управление тегами
                    </button>
                    <div class="collapse mt-3" id="tagManagement">
                        <form th:action="@{/tasks/tags/create}" method="post" th:object="${newTag}"
                        style="display: flex; flex-direction: row; flex-wrap: wrap;">
                            <div class="mb-3">
                                <label class="form-label">Название тега</label>
                                <input type="text" class="form-control" th:field="*{name}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Цвет</label>
                                <input type="color" class="form-control form-control-color" th:field="*{color}" value="#563d7c">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-plus me-1"></i>Создать тег
                            </button>
                        </form>

                        <div class="tag-list mt-4" style="flex-wrap: wrap">
                            <h6 class="fw-bold mb-3"><i class="fas fa-tag me-1"></i>Мои теги:</h6>
                            <div th:each="tag : ${allTags}" class="tag-item">
                                    <span class="badge fs-6" th:style="'background-color: ' + ${tag.color}"
                                          th:text="${tag.name}"></span>
                                <form th:action="@{'/tasks/tags/delete/' + ${tag.id}}" method="post">
                                    <button type="submit" class="tag-delete-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Выполненные задачи -->
                <div class="sidebar-card">
                    <button class="sidebar-btn" data-bs-toggle="collapse" data-bs-target="#completedTasks">
                        <i class="fas fa-check-circle me-2"></i>Выполненные задачи
                        <span class="badge bg-success ms-2" th:text="${#lists.size(completedTasks)}"></span>
                    </button>
                    <div class="collapse mt-3" id="completedTasks">
                        <div th:if="${#lists.isEmpty(completedTasks)}" class="alert alert-info py-2">
                            Нет выполненных задач
                        </div>
                        <div th:each="task : ${completedTasks}" class="completed-task-item">
                            <a th:href="@{/tasks/{id}(id=${task.customId})}"
                               th:text="${task.customId + ': ' + task.title}"
                               class="text-decoration-none"></a>
                            <small class="d-block text-muted">
                                <i class="far fa-clock me-1"></i>
                                <span th:text="${#temporals.format(task.completedAt, 'dd.MM.yyyy HH:mm')}"></span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Скрипты -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Обработчик кнопки комментариев
    $('.toggle-comments').click(function() {
        const taskId = $(this).data('task-id');
        const container = $(this).next('.comments-container');
        container.collapse('toggle');
    });

    // Подсветка ключевых слов
    $('.card-text').each(function() {
        const text = $(this).text();
        const keywords = $(this).closest('.task-card').find('.keyword-badge').map(function() {
            return $(this).text();
        }).get();

        if (keywords.length > 0) {
            let highlightedText = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(keyword, 'gi');
                highlightedText = highlightedText.replace(regex,
                    `<span class="highlighted-keyword">${keyword}</span>`);
            });
            $(this).html(highlightedText);
        }
    });
</script>
<script>
    // Подсветка ключевых слов при наведении
    document.addEventListener('DOMContentLoaded', function() {
        // Подсветка соответствующих ключевых слов при наведении
        const keywordBadges = document.querySelectorAll('.keyword-badge');

        keywordBadges.forEach(badge => {
            const keyword = badge.getAttribute('data-keyword');

            badge.addEventListener('mouseenter', function() {
                // Подсветка этого ключевого слова в тексте
                highlightKeywordInText(keyword);
            });

            badge.addEventListener('mouseleave', function() {
                // Убрать подсветку
                removeHighlightFromText();
            });

            badge.addEventListener('click', function() {
                // Поиск по этому ключевому слову
                searchByKeyword(keyword);
            });
        });
    });

    function highlightKeywordInText(keyword) {
        // Подсветка ключевого слова в описаниях задач
        const descriptions = document.querySelectorAll('.card-text');
        descriptions.forEach(desc => {
            const text = desc.textContent;
            const regex = new RegExp(`(${keyword})`, 'gi');
            const highlighted = text.replace(regex, '<mark class="keyword-highlight">$1</mark>');
            desc.innerHTML = highlighted;
        });
    }

    function removeHighlightFromText() {
        // Убрать подсветку
        const marks = document.querySelectorAll('.keyword-highlight');
        marks.forEach(mark => {
            mark.outerHTML = mark.textContent;
        });
    }

    function searchByKeyword(keyword) {
        // Перенаправить на поиск по ключевому слову
        window.location.href = `/tasks/search?keyword=${encodeURIComponent(keyword)}`;
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchCard = document.getElementById('searchCard');
        const searchButton = document.querySelector('.collapsible-search-btn');

        // Восстановление состояния из localStorage
        const isSearchOpen = localStorage.getItem('searchOpen') === 'true';
        if (isSearchOpen) {
            const bsCollapse = new bootstrap.Collapse(searchCard, { toggle: false });
            bsCollapse.show();
            updateButtonText(true);
        }

        // Обработчики событий
        searchCard.addEventListener('show.bs.collapse', function() {
            localStorage.setItem('searchOpen', 'true');
            updateButtonText(true);
        });

        searchCard.addEventListener('hide.bs.collapse', function() {
            localStorage.setItem('searchOpen', 'false');
            updateButtonText(false);
        });

        // Автоматическое открытие при поиске
        const hasSearch = window.location.search.includes('keyword=') ||
            window.location.search.includes('tagIds=') ||
            window.location.pathname.includes('/filter/tag/');

        if (hasSearch) {
            setTimeout(() => {
                const bsCollapse = new bootstrap.Collapse(searchCard);
                bsCollapse.show();
            }, 100);
        }

        function updateButtonText(isOpen) {
            const textElement = document.querySelector('.search-btn-text');
            const arrow = document.querySelector('.search-arrow');

            if (isOpen) {
                textElement.textContent = 'Скрыть поиск и фильтры';
            } else {
                textElement.textContent = 'Показать поиск и фильтры';
            }
        }
    });
</script>
</body>
</html>