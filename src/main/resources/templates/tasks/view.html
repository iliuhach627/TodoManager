<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${task.customId + ': ' + task.title}">Task</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/tasks.css" rel="stylesheet">
    <style>
        .bg-gradient {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        }
        .keyword-badge {
            display: inline-block;
            padding: 4px 10px;
            background-color: #e3f2fd;
            border-radius: 15px;
            font-size: 0.85em;
            color: #1976d2;
            margin: 2px;
        }
        .highlighted-keyword {
            background-color: #fff59d;
            padding: 0 4px;
            border-radius: 3px;
        }
        .btn-home {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
<!-- Навигационная панель -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="/tasks">
            <i class="fas fa-tasks me-2"></i>Task Manager
        </a>
        <div>
            <a href="/tasks" class="btn btn-outline-primary">
                <i class="fas fa-home me-1"></i>На главную
            </a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Кнопка назад -->
    <a href="/tasks" class="btn btn-outline-secondary mb-4">
        <i class="fas fa-arrow-left me-2"></i>Назад к списку
    </a>

    <!-- Детали задачи -->
    <div class="task-details-card card shadow-lg mb-4"
         th:class="${task.status == T(org.shetsko.model.enums.TaskStatus).COMPLETED} ? 'completed' : ''"
         th:classappend="${task.priority == T(org.shetsko.model.enums.Priority).HIGH} ? 'high-priority' :
         (${task.priority == T(org.shetsko.model.enums.Priority).MEDIUM} ? 'medium-priority' : 'low-priority')">

        <div class="card-header bg-gradient text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1" th:text="${task.customId + ': ' + task.title}"></h2>
                    <div class="task-meta">
                            <span class="badge me-2"
                                  th:classappend="${task.status == T(org.shetsko.model.enums.TaskStatus).COMPLETED} ? 'bg-success' : 'bg-primary'"
                                  th:text="${task.status.getTranslate()}"></span>
                        <span class="badge me-2"
                              th:classappend="${task.priority == T(org.shetsko.model.enums.Priority).HIGH} ? 'bg-danger' :
                                            (${task.priority == T(org.shetsko.model.enums.Priority).MEDIUM} ? 'bg-warning' : 'bg-success')"
                              th:text="${task.priority.getTranslate()}"></span>
                        <small class="text-white-50">
                            <i class="far fa-calendar-alt me-1"></i>
                            Создано: <span th:text="${#temporals.format(task.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
                        </small>
                    </div>
                </div>
                <form th:action="@{/tasks/{id}/complete(id=${task.customId})}" method="post" th:if="${task.status != T(org.shetsko.model.enums.TaskStatus).COMPLETED}">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle me-1"></i>Завершить задачу
                    </button>
                </form>
            </div>
        </div>

        <div class="card-body">
            <!-- Описание задачи -->
            <div class="mb-4">
                <h5 class="text-primary"><i class="fas fa-align-left me-2"></i>Описание</h5>
                <p class="task-description" th:text="${task.description}"></p>
            </div>

            <!-- Теги -->
            <div class="mb-4" th:if="${not #lists.isEmpty(task.tags)}">
                <h5 class="text-primary"><i class="fas fa-tags me-2"></i>Теги</h5>
                <div class="d-flex flex-wrap gap-2">
                        <span th:each="tag : ${task.tags}"
                              class="badge fs-6"
                              th:style="'background-color: ' + ${tag.color} + '; color: white'"
                              th:text="${tag.name}"></span>
                </div>
            </div>

            <!-- Ключевые слова с источниками -->
            <div class="mb-4" th:if="${not #maps.isEmpty(keywordsWithSource)}">
                <h5 class="text-primary"><i class="fas fa-key me-2"></i>Ключевые слова</h5>
                <div class="d-flex flex-wrap gap-2">
                    <th:block th:each="entry : ${keywordsWithSource}">
            <span class="keyword-badge position-relative" th:attr="data-keyword=${entry.key}">
                <span th:text="${entry.key}"></span>
                <span class="keyword-source-tooltip">
                    <i class="fas fa-info-circle ms-1"></i>
                    <span class="keyword-source-content">
                        Найдено в:
                        <span th:text="${#strings.listJoin(entry.value, ', ')}"></span>
                    </span>
                </span>
            </span>
                    </th:block>
                </div>
            </div>


            <!-- Связанные задачи -->
            <div class="mb-4" th:if="${not #lists.isEmpty(task.referencedTasks)}">
                <h5 class="text-primary"><i class="fas fa-link me-2"></i>Связанные задачи</h5>
                <div class="list-group">
                    <a th:each="refTask : ${task.referencedTasks}"
                       th:href="@{/tasks/{id}(id=${refTask.customId})}"
                       class="list-group-item list-group-item-action">
                        <i class="fas fa-arrow-right me-2"></i>
                        <span th:text="${refTask.customId + ': ' + refTask.title}"></span>
                    </a>
                </div>
            </div>

            <!-- Добавление тега -->
            <div class="mb-4">
                <h5 class="text-primary"><i class="fas fa-plus-circle me-2"></i>Добавить тег</h5>
                <form th:action="@{/tasks/{id}/tags(id=${task.customId})}" method="post" class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <select id="selectTags" name="tagId" class="form-select">
                            <option value="">Выберите тег...</option>
                            <option th:each="tag : ${allTags}"
                                    th:value="${tag.id}"
                                    th:text="${tag.name}"
                                    th:style="'color: ' + ${tag.color}"></option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="addTagToTask" type="submit" class="btn btn-primary w-100" disabled>
                            <i class="fas fa-plus me-1"></i>Добавить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        document.getElementById('selectTags').addEventListener('change', function() {
            const button = document.getElementById('addTagToTask');
            button.disabled = this.value === '';
        });
    </script>

    <!-- Секция комментариев -->
    <div class="comments-section card shadow-lg">
        <div class="card-header bg-light">
            <h4 class="mb-0">
                <i class="fas fa-comments me-2"></i>Комментарии
                <span class="badge bg-primary ms-2" th:text="${#lists.size(task.comments)}"></span>
            </h4>
        </div>

        <div class="card-body">
            <!-- Список комментариев -->
            <div th:each="comment : ${task.comments}" class="comment-item mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">
                                <i class="far fa-clock me-1"></i>
                                <span th:text="${#temporals.format(comment.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
                            </small>
                            <form th:action="@{'/tasks/' + ${task.customId} + '/comments/' + ${comment.id} + '/delete'}"
                                  method="post">
                                <input type="hidden" name="_method" value="delete"/>
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash-alt"></i> Удалить
                                </button>
                            </form>
                        </div>
                        <p class="card-text mb-0" th:text="${comment.content}"></p>
                    </div>
                </div>
            </div>

            <!-- Форма добавления комментария -->
            <div class="add-comment-form mt-4">
                <h5 class="text-primary mb-3"><i class="fas fa-plus-circle me-2"></i>Добавить комментарий</h5>
                <form th:action="@{/tasks/{id}/comments(id=${task.customId})}" method="post" th:object="${newComment}">
                    <div class="mb-3">
                            <textarea class="form-control" th:field="*{content}" rows="4"
                                      placeholder="Введите ваш комментарий..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Отправить комментарий
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Фаб-кнопка "На главную" -->
<a href="/tasks" class="btn btn-primary btn-home d-lg-none">
    <i class="fas fa-home"></i>
</a>

<!-- Скрипты -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Подсветка ключевых слов в описании
    document.addEventListener('DOMContentLoaded', function() {
        const descriptionElement = document.querySelector('.task-description');
        if (descriptionElement) {
            const text = descriptionElement.textContent;
            const keywords = document.querySelectorAll('.keyword-badge');

            if (keywords.length > 0) {
                let highlightedText = text;
                keywords.forEach(keywordElement => {
                    const keyword = keywordElement.textContent;
                    const regex = new RegExp(keyword, 'gi');
                    highlightedText = highlightedText.replace(regex,
                        `<span class="highlighted-keyword">${keyword}</span>`);
                });
                descriptionElement.innerHTML = highlightedText;
            }
        }
    });
</script>

<script>
    // Подсветка ключевых слов при наведении
    document.addEventListener('DOMContentLoaded', function() {
        // Подсветка соответствующих ключевых слов при наведении
        const keywordBadges = document.querySelectorAll('.keyword-badge');

        keywordBadges.forEach(badge => {
            const keyword = badge.getAttribute('data-keyword');

            badge.addEventListener('mouseenter', function() {
                // Подсветка этого ключевого слова в тексте
                highlightKeywordInText(keyword);
            });

            badge.addEventListener('mouseleave', function() {
                // Убрать подсветку
                removeHighlightFromText();
            });

            badge.addEventListener('click', function() {
                // Поиск по этому ключевому слову
                searchByKeyword(keyword);
            });
        });
    });

    function highlightKeywordInText(keyword) {
        // Подсветка ключевого слова в описаниях задач
        const descriptions = document.querySelectorAll('.card-text');
        descriptions.forEach(desc => {
            const text = desc.textContent;
            const regex = new RegExp(`(${keyword})`, 'gi');
            const highlighted = text.replace(regex, '<mark class="keyword-highlight">$1</mark>');
            desc.innerHTML = highlighted;
        });
    }

    function removeHighlightFromText() {
        // Убрать подсветку
        const marks = document.querySelectorAll('.keyword-highlight');
        marks.forEach(mark => {
            mark.outerHTML = mark.textContent;
        });
    }

    function searchByKeyword(keyword) {
        // Перенаправить на поиск по ключевому слову
        window.location.href = `/tasks/search?keyword=${encodeURIComponent(keyword)}`;
    }
</script>
</body>
</html>